name: "CI ubuntu"
on: [push]
jobs:
  compile:
    if: |
      !contains(github.event.head_commit.message, 'SKIP')
    runs-on: ubuntu-latest
    container: ubuntu:rolling
    steps:
      - uses: actions/checkout@v2
      - run: apt-get -qq update
      - run: |
          apt-get -qq -y install \
            cmake git g++ gcc make sudo tar wget curl xz-utils pip clang graphviz

        env:
          DEBIAN_FRONTEND: noninteractive

      - name: "Install conan"
        run: pip install conan
      - name: "Install boost wave reader dependencies and build library"
        run: |
          cd src/hcparse/read_boost_wave
          conan install . --build=missing --settings compiler.libcxx="libstdc++11"
          mkdir build
          cd build
          cmake ..
          make -j8
          cd ..

      - name: "Install nim"
        run: |
          wget https://nim-lang.org/choosenim/init.sh
          chmod +x init.sh
          sh init.sh -y

      - name: "Install libclang"
        run: |
          apt-get install -y wget gnupg
          wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | apt-key add -
          echo "deb http://apt.llvm.org/hirsute/ llvm-toolchain-hirsute-13 main" | tee /etc/apt/sources.list.d/llvm.list
          echo "deb-src http://apt.llvm.org/hirsute/ llvm-toolchain-hirsute-13 main" | tee -a /etc/apt/sources.list.d/llvm.list
          apt-get update

          apt-get install -y libclang-13-dev libclang1-13

        env:
          DEBIAN_FRONTEND: noninteractive

      - name: "Install tree-sitter"
        run: |
          wget "https://github.com/tree-sitter/tree-sitter/archive/refs/tags/v${TS_VERSION}.tar.gz" && \
          tar -xvf "v${TS_VERSION}.tar.gz" && \
          cd "tree-sitter-${TS_VERSION}" && \
          sudo make install PREFIX=/usr
        env:
          TS_VERSION: "0.20.0"

      - name: "Install nim dependencies"
        run: |
          export PATH=$HOME/.nimble/bin:$PATH
          echo $PATH
          nimble -y develop

      - name: "Execute tests and build documentation"
        shell: bash
        run: |
          export PATH=$HOME/.nimble/bin:$PATH
          echo $PATH

          # Setup paths to the wavereader library and llvm installation
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/lib/llvm-13/lib:$(pwd)/lib
          export LIBRARY_PATH=$LIBRARY_PATH:/usr/lib/llvm-13/lib:$(pwd)/lib

          echo $LD_LIBRARY_PATH
          echo $LIBRARY_PATH

          # Setup paths for conan dependencies
          cat src/hcparse/read_boost_wave/activate_run.sh
          source src/hcparse/read_boost_wave/activate_run.sh

          # Add path to the current nim compiler installation
          echo '--path="$nim"' > nim.cfg
          cat nim.cfg

          # Run tests
          nim r tests/runall.nim test $(pwd)/hcparse.nimble
