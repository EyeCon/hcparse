name: test
on: [push]
jobs:
  compile:
    if: |
      !contains(github.event.head_commit.message, 'SKIP')
    runs-on: ubuntu-latest
    container: ubuntu:latest
    steps:
      - uses: actions/checkout@v2
      - run: apt-get -qq update
      - run: apt-get -qq -y install cmake git g++ gcc make sudo tar wget curl xz-utils pip
        env:
          DEBIAN_FRONTEND: noninteractive

      - run: |
          apt-get -qq -y install \
            libboost-filesystem-dev \
            libboost-wave-dev \
            libboost-thread-dev \
            libboost-system-dev

      # - run: pip install conan
      - run: |
          cd src/hcparse/read_boost_wave
          #conan install . --build=missing
          mkdir build
          cd build
          cmake ..
          make -j8
          cd ..

      - run: |
          wget https://nim-lang.org/choosenim/init.sh
          chmod +x init.sh
          sh init.sh -y

      - run: apt-get -y install libclang-dev

      - run: |
          wget "https://github.com/tree-sitter/tree-sitter/archive/refs/tags/v${TS_VERSION}.tar.gz" && \
          tar -xvf "v${TS_VERSION}.tar.gz" && \
          cd "tree-sitter-${TS_VERSION}" && \
          sudo make install PREFIX=/usr
        env:
          TS_VERSION: "0.20.0"

      - run: |
          export PATH=$HOME/.nimble/bin:$PATH
          echo $PATH
          nimble -y develop

      - run: |
          nim r tests/runall.nim test $(pwd)/hcparse.nimble

      - run: |
          nim r tests/runall.nim doc $(pwd)/hcparse.nimble --ignore="**/dox*.nim"

      - uses: crazy-max/ghaction-github-pages@v1
        with:
          build_dir: htmldocs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
